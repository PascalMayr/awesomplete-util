// AwesompleteUtil - Nico Hoogervorst - MIT license
var AwesompleteUtil=function(){function j(a){var b=Array.isArray(a)?{label:a[0],value:a[1]}:"object"==typeof a&&"label"in a&&"value"in a?a:{label:a,value:a};return{label:b.label||b.value,value:b.value}}function k(a,b,c){return i.fire(a,b,{detail:c})}function l(a,b){var p,q,r,s,c=a.input,f=a.utilprops,i=f.selected,l=f.convertInput(c.value),m=a.opened,n=[],o=a._list;if(f.prepop=!1,o){for(s=0;s<o.length;s++)if(r=o[s],p=j(a.data(r,l)),0===a.maxItems&&a.filter(p,l)&&(m=!0),q={input:{value:""}},a.replace.call(q,p),f.convertInput(q.input.value)===l){if(i&&i.value===p.value&&i.label===p.label){n=[r];break}n.push(r)}f.prevSelected!==n&&n.length>0?b?k(c,e,n):f.changed&&(f.prevSelected=n,c.classList.remove(h),c.classList.add(g),k(c,d,n)):f.changed&&(f.prevSelected=null,c.classList.remove(g),m&&c===document.activeElement?c.classList.remove(h):l.length>0&&(c.classList.add(h),k(c,d,[])))}}function m(a){var d=this;a.type!==c&&a.type!==b&&"blur"!=a.type||a.target!==d.input||l(d,d.utilprops.prepop&&a.type===b)}function n(a){var b=this;a.target===b.input&&9===a.keyCode&&b.select()}function o(a){var b=this;b.utilprops.changed=!0,b.utilprops.selected=a.text}function p(a){return 0===Object.keys(a).length&&a.constructor===Object}function q(){var g,h,a=this,c=a.w,d=a.xhr,e=a.queryParam,f=c.utilprops.val;if(200===d.status){if(g=JSON.parse(d.responseText),c.utilprops.convertResponse&&(g=c.utilprops.convertResponse(g)),!Array.isArray(g))for(h in g)if(Array.isArray(g[h])){g=g[h];break}Array.isArray(g)||1!==c.utilprops.limit||(g=p(g)?[]:[g]),Array.isArray(g)&&(!c.utilprops.listQuery||!c.utilprops.loadall&&0===f.lastIndexOf(e,0)&&(0!==f.lastIndexOf(c.utilprops.listQuery,0)||c.utilprops.limit>1&&c._list.length>=c.utilprops.limit))&&(c.list=g,c.utilprops.listQuery=e||c.utilprops.loadall,k(c.input,b,e))}}function r(a,b){var c;a.utilprops.url&&(!a.utilprops.listQuery||!a.utilprops.loadall&&(0!==b.lastIndexOf(a.utilprops.listQuery,0)||a.utilprops.limit>1&&a._list.length>=a.utilprops.limit))?(c=new XMLHttpRequest,a.utilprops.ajax(a.utilprops.url,a.utilprops.urlEnd,a.utilprops.loadall?"":b,q.bind({w:a,xhr:c,queryParam:b}),c)):l(a,a.utilprops.prepop)}function s(a){var b=a.input;b.classList.remove(g),b.classList.remove(h),k(b,d,[])}function t(a,b,c){return a.utilprops.prepop=c||!1,a.utilprops.val!==b&&(a.utilprops.selected=null,a.utilprops.changed=!0,a.utilprops.val=b,(b.length<a.minChars||0==b.length)&&s(a),b.length>=a.minChars&&r(a,b)),a}function u(a){var c,b=this;a.target===b.input&&(c=b.utilprops.convertInput(b.input.value),t(b,c))}function v(a){return i.create("li",{innerHTML:a,"aria-selected":"false"})}function w(a){return a.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;")}function x(a){var f,g,b=this,c=b.s,d=b.z,e=b.b;a.target===i(c)&&("function"==typeof e?e(a,d):(f=i(e),f&&f!==document.activeElement&&(g=Array.isArray(a.detail)&&1===a.detail.length?a.detail[0]:null,g=("undefined"!=typeof d&&g?g[d]:g)||"","undefined"!=typeof f.value?f.value=g:"undefined"!=typeof f.src?f.src=g:f.innerHTML=g)))}function y(a){var c,b=this;a.target===i(b.btnId)&&(c=i(b.w),0===c.ul.childNodes.length?(c.minChars=0,c.evaluate()):c.ul.hasAttribute("hidden")?c.open():c.close())}function z(a,b,c){var d=i.regExpEscape(w(b).trim()),e=c?RegExp("^"+d,"i"):RegExp("(?!<[^>]+?>)"+d+"(?![^<]*?>)","gi");return a.replace(e,"<mark>$&</mark>")}function A(a,b,c,d,e){var k,f=e.root,g=e.value,h=e.label||e.value,i=!0,j=[];if(0===d&&f&&c&&0!==(c+".").lastIndexOf(f+".",0)&&0!==(f+".").lastIndexOf(c+".",0))return a;if(Object(b)!==b)c?a[c]=b:a=b;else if(Array.isArray(b)){for(k=0;k<b.length;k++)j.push(A({},b[k],"",d+1,e));c?a[c]=j:a=j}else{for(k in b)i=!1,A(a,b[k],c?c+"."+k:k,d,e);i&&c&&(a[c]={})}return 2>d&&c&&(g&&0===(c+".").lastIndexOf(g+".",0)&&(a.value=a[c]),h&&0===(c+".").lastIndexOf(h+".",0)&&(a.label=a[c])),a}function B(){var a=this,d=a.w.input,e=a.bm,g=a.bi,h=a.bk,i=a.bs;d.removeEventListener(f,i),d.removeEventListener(b,e),d.removeEventListener(c,e),d.removeEventListener("blur",e),d.removeEventListener("input",g),d.removeEventListener("keydown",h)}var a="awesomplete-",b=a+"loadcomplete",c=a+"close",d=a+"match",e=a+"prepop",f=a+"select",g="awe-found",h="awe-not-found",i=Awesomplete.$;return{ajax:function(a,b,c,d,e){return e=e||new XMLHttpRequest,e.open("GET",a+encodeURIComponent(c)+(b||"")),e.onload=d,e.send(),e},convertInput:function(a){return"string"==typeof a?a.trim().toLowerCase():""},mark:z,itemContains:function(a,b){var c;return""!==b.trim()&&(c=(""+a).split(/<p>/),c[0]=z(c[0],b),a=c.join("<p>")),v(a,b)},itemStartsWith:function(a,b){return v(""===b.trim()?""+a:z(""+a,b,!0),b)},createAwesomplete:function(a,b,c){c.item=c.item||this.itemContains;var d=new Awesomplete(a,c);return d.utilprops=b||{},d.utilprops.url||"undefined"!=typeof d.utilprops.loadall||(d.utilprops.loadall=!0),d.utilprops.ajax=d.utilprops.ajax||this.ajax,d.utilprops.convertInput=d.utilprops.convertInput||this.convertInput,d},attach:function(a){var d=a.input,e=m.bind(a),g=n.bind(a),h=u.bind(a),j=o.bind(a),k=B.bind({w:a,bm:e,bi:h,bk:g,bs:j}),l={keydown:g,input:h};return l.blur=l[c]=l[b]=e,l[f]=j,i.bind(d,l),a.utilprops.detach=k,a.utilprops.prepop&&(a.utilprops.loadall||""!==d.value)&&(a.utilprops.val=a.utilprops.convertInput(d.value),r(a,a.utilprops.val)),a},update:function(a,b,c){return a.input.value=b,t(a,b,c)},startAwesomplete:function(a,b,c){return this.attach(this.createAwesomplete(a,b,c))},detach:function(a){return a.utilprops.detach&&(a.utilprops.detach(),delete a.utilprops.detach),a},createCopyFun:function(a,b,c){return x.bind({s:a,z:b,b:c})},attachCopyFun:function(a,b){return b="boolean"==typeof b?b:!0,addEventListener(d,a),b&&addEventListener(e,a),a},startCopy:function(a,b,c,d){return this.attachCopyFun(this.createCopyFun(a,b,c),d)},detachCopyFun:function(a){return removeEventListener(e,a),removeEventListener(d,a),a},createClickFun:function(a,b){return y.bind({btnId:a,w:b})},attachClickFun:function(a){return addEventListener("click",a),a},startClick:function(a,b){return this.attachClickFun(this.createClickFun(a,b))},detachClickFun:function(a){return removeEventListener("click",a),a},filterContains:function(a,b){return Awesomplete.FILTER_CONTAINS(a.value,b)},filterStartsWith:function(a,b){return Awesomplete.FILTER_STARTSWITH(a.value,b)},jsonFlatten:function(a){return A({},a,"",0,this)}}}();
