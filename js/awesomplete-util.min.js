// AwesompleteUtil - Nico Hoogervorst - MIT license
var AwesompleteUtil=function(){function t(t){var e=Array.isArray(t)?{label:t[0],value:t[1]}:"object"==typeof t&&"label"in t&&"value"in t?t:{label:t,value:t};return{label:e.label||e.value,value:e.value}}function e(t,e,n){return F.fire(t,e,{detail:n})}function n(n,r){var i,l,a,u,o=n.input,s=n.utilprops,p=s.selected,c=s.convertInput(o.value),v=n.opened,d=[],f=n._list;if(s.prepop=!1,f){for(u=0;u<f.length;u++)if(a=f[u],i=t(n.data(a,c)),0===n.maxItems&&n.filter(i,c)&&(v=!0),l={input:{value:""}},n.replace.call(l,i),s.convertInput(l.input.value)===c){if(p&&p.value===i.value&&p.label===i.label){d=[a];break}d.push(a)}s.prevSelected!==d&&(d.length>0?r?e(o,C,d):s.changed&&(s.prevSelected=d,o.classList.remove(k),o.classList.add(x),e(o,w,d)):r?e(o,C,[]):s.changed&&(s.prevSelected=[],o.classList.remove(x),v&&o===document.activeElement?o.classList.remove(k):c.length>0&&(o.classList.add(k),e(o,w,[]))))}}function r(t){var e=this;t.type!==I&&t.type!==A&&"blur"!=t.type||t.target!==e.input||n(e,e.utilprops.prepop&&t.type===A)}function i(t){var e=this;t.target===e.input&&9===t.keyCode&&e.select()}function l(t){var e=this;e.utilprops.changed=!0,e.utilprops.selected=t.text}function a(t){return 0===Object.keys(t).length&&t.constructor===Object}function u(t,e,n){var r=t.utilprops;return!r.listQuery||!r.loadall&&0===e.lastIndexOf(n,0)&&(0!==e.lastIndexOf(r.listQuery,0)||r.limit>1&&t._list.length>=r.limit)}function o(){var t,n,r=this,i=r.w,l=r.xhr,o=r.queryParam,s=i.utilprops.val;if(200===l.status){if(t=JSON.parse(l.responseText),i.utilprops.convertResponse&&(t=i.utilprops.convertResponse(t)),!Array.isArray(t))for(n in t)if(Array.isArray(t[n])){t=t[n];break}Array.isArray(t)||1!==i.utilprops.limit||(t=a(t)?[]:[t]),Array.isArray(t)&&u(i,s,o)&&(i.list=t,i.utilprops.listQuery=o||i.utilprops.loadall,e(i.input,A,o))}}function s(t,e){var r;t.utilprops.url&&u(t,e,e)?(r=new XMLHttpRequest,t.utilprops.ajax(t.utilprops.url,t.utilprops.urlEnd,t.utilprops.loadall?"":e,o.bind({w:t,xhr:r,queryParam:e}),r)):n(t,t.utilprops.prepop)}function p(t){var n=t.input;n.classList.remove(k,x),e(n,w,[])}function c(t,e,n){return t.utilprops.prepop=n||!1,t.utilprops.val!==e&&(t.utilprops.selected=null,t.utilprops.changed=!0,t.utilprops.val=e,(e.length<t.minChars||0==e.length)&&p(t),e.length<t.minChars||s(t,e)),t}function v(t){var e,n=this;t.target===n.input&&(e=n.utilprops.convertInput(n.input.value),c(n,e))}function d(t){return F.create("li",{innerHTML:t,"aria-selected":"false"})}function f(t){return t.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;")}function h(t){var e,n,r=this,i=r.s,l=r.z,a=r.b;t.target===F(i)&&("function"==typeof a?a(t,l):(e=F(a),e&&e!==document.activeElement&&(n=Array.isArray(t.detail)&&1===t.detail.length?t.detail[0]:null,n=(l&&n?n[l]:n)||"",void 0!==e.value?(e.value=n,e.classList&&e.classList.remove&&e.classList.remove(k)):void 0!==e.src?e.src=n:e.innerHTML=n)))}function m(t){var e,n,r=this;t.target===F(r.btnId)&&(e=r.w,0===e.ul.childNodes.length||e.ul.hasAttribute("hidden")?(n=e.minChars,e.minChars=0,e.evaluate(),e.minChars=n):e.close())}function b(t,e,n){var r=F.regExpEscape(f(e).trim()),i=r.length>0?n?RegExp("^"+r,"i"):RegExp("(?!<[^>]+?>)"+r+"(?![^<]*?>)","gi"):null;return t.replace(i,"<mark>$&</mark>")}function y(t,e,n,r,i){var l,a=i.root,u=i.value,o=i.label||i.value,s=!0,p=[];if(0===r&&a&&n&&0!==(n+".").lastIndexOf(a+".",0)&&0!==(a+".").lastIndexOf(n+".",0))return t;if(Object(e)!==e)n?t[n]=e:t=e;else if(Array.isArray(e)){for(l=0;l<e.length;l++)p.push(y({},e[l],"",r+1,i));n?t[n]=p:t=p}else{for(l in e)s=!1,y(t,e[l],n?n+"."+l:l,r,i);s&&n&&(t[n]={})}return 2>r&&n&&(u&&0===(n+".").lastIndexOf(u+".",0)&&(t.value=t[n]),o&&0===(n+".").lastIndexOf(o+".",0)&&(t.label=t[n])),t}function g(){var t=this,e=t.w.input,n=t.bm,r=t.bi,i=t.bk,l=t.bs;e.removeEventListener(E,l),e.removeEventListener(A,n),e.removeEventListener(I,n),e.removeEventListener("blur",n),e.removeEventListener("input",r),e.removeEventListener("keydown",i)}var L="awesomplete-",A=L+"loadcomplete",I=L+"close",w=L+"match",C=L+"prepop",E=L+"select",x="awe-found",k="awe-not-found",F=Awesomplete.$;return{ajax:function(t,e,n,r,i){return i=i||new XMLHttpRequest,i.open("GET",t+encodeURIComponent(n)+(e||"")),i.onload=r,i.send(),i},convertInput:function(t){return"string"==typeof t?t.trim().toLowerCase():""},item:d,mark:b,itemContains:function(t,e){var n;return e.trim().length>0&&(n=(""+t).split(/<p>/),n[0]=b(n[0],e),t=n.join("<p>")),d(t,e)},itemStartsWith:function(t,e){return d(""===e.trim()?""+t:b(""+t,e,!0),e)},createAwesomplete:function(t,e,n){n.item=n.item||this.itemContains;var r=new Awesomplete(t,n);return r.utilprops=e||{},r.utilprops.url||void 0!==r.utilprops.loadall||(r.utilprops.loadall=!0),r.utilprops.ajax=r.utilprops.ajax||this.ajax,r.utilprops.convertInput=r.utilprops.convertInput||this.convertInput,r},attach:function(t){var e=t.input,n=r.bind(t),a=i.bind(t),u=v.bind(t),o=l.bind(t),p=g.bind({w:t,bm:n,bi:u,bk:a,bs:o}),c={keydown:a,input:u};return c.blur=c[I]=c[A]=n,c[E]=o,F.bind(e,c),t.utilprops.detach=p,t.utilprops.prepop&&(t.utilprops.loadall||e.value.length>0)&&(t.utilprops.val=t.utilprops.convertInput(e.value),s(t,t.utilprops.val)),t},update:function(t,e,n){return t.input.value=e,c(t,e,n)},startAwesomplete:function(t,e,n){return this.attach(this.createAwesomplete(t,e,n))},detach:function(t){return t.utilprops.detach&&(t.utilprops.detach(),delete t.utilprops.detach),t},createCopyFun:function(t,e,n){return h.bind({s:F(t)||t,z:e,b:F(n)||n})},attachCopyFun:function(t,e){return e="boolean"==typeof e?e:!0,addEventListener(w,t),e&&addEventListener(C,t),t},startCopy:function(t,e,n,r){return this.attachCopyFun(this.createCopyFun(t,e,n),r)},detachCopyFun:function(t){return removeEventListener(C,t),removeEventListener(w,t),t},createClickFun:function(t,e){return m.bind({btnId:F(t)||t,w:e})},attachClickFun:function(t){return addEventListener("click",t),t},startClick:function(t,e){return this.attachClickFun(this.createClickFun(t,e))},detachClickFun:function(t){return removeEventListener("click",t),t},filterContains:function(t,e){return Awesomplete.FILTER_CONTAINS(t.value,e)},filterStartsWith:function(t,e){return Awesomplete.FILTER_STARTSWITH(t.value,e)},jsonFlatten:function(t){return y({},t,"",0,this)}}}();
