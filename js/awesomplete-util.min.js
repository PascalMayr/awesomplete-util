// AwesompleteUtil - Nico Hoogervorst - MIT license
var AwesompleteUtil=function(){function t(t){var e=Array.isArray(t)?{label:t[0],value:t[1]}:"object"==typeof t&&"label"in t&&"value"in t?t:{label:t,value:t};return{label:e.label||e.value,value:e.value}}function e(t,e,r){return E.fire(t,e,{detail:r})}function r(r,n){var i,l,u,p,o=r.input,a=r.utilprops.convertInput(o.value),s=r.opened,c=null;if(r.utilprops.prepop=!1,r.utilprops.prevSelected!==a&&r._list){for(p=0;p<r._list.length;p++)if(u=r._list[p],i=t(r.data(u,a)),0===r.maxItems&&r.filter(i,a)&&(s=!0),l={input:{value:""}},r.replace.call(l,i),r.utilprops.convertInput(l.input.value)===a){c=u;break}r.utilprops.prevSelected!==a&&null!==c?n?e(o,A,c):r.utilprops.changed&&(r.utilprops.prevSelected=a,r.input.classList.remove(C),r.input.classList.add(I),e(o,w,c)):r.utilprops.changed&&(r.utilprops.prevSelected=null,r.input.classList.remove(I),s&&o===document.activeElement?r.input.classList.remove(C):a.length>0&&(r.input.classList.add(C),e(o,w,null)))}}function n(t){var e=this;t.type!==L&&t.type!==g&&"blur"!=t.type||t.target!==e.input||(t.type===L&&(e.utilprops.changed=!0),r(e,e.utilprops.prepop&&t.type===g))}function i(t){var e=this;t.target===e.input&&9===t.keyCode&&e.select()}function l(t){return 0===Object.keys(t).length&&t.constructor===Object}function u(){var t,r,n=this,i=n.w,u=n.xhr,p=n.queryParam,o=i.utilprops.val;if(200===u.status){if(t=JSON.parse(u.responseText),i.utilprops.convertResponse&&(t=i.utilprops.convertResponse(t)),!Array.isArray(t))for(r in t)if(Array.isArray(t[r])){t=t[r];break}Array.isArray(t)||1!==i.utilprops.limit||(t=l(t)?[]:[t]),Array.isArray(t)&&(!i.utilprops.listQuery||!i.utilprops.loadall&&0===o.lastIndexOf(p,0)&&(0!==o.lastIndexOf(i.utilprops.listQuery,0)||i.utilprops.limit>1&&i._list.length>=i.utilprops.limit))&&(i.list=t,i.utilprops.listQuery=p||i.utilprops.loadall,e(i.input,g,p))}}function p(t,e){var n;!t.utilprops.url||t.utilprops.listQuery&&(t.utilprops.loadall||0===e.lastIndexOf(t.utilprops.listQuery,0)&&(t.utilprops.limit<=1||t._list.length<t.utilprops.limit))?r(t,t.utilprops.prepop):(n=new XMLHttpRequest,t.utilprops.ajax(t.utilprops.url,t.utilprops.urlEnd,t.utilprops.loadall?"":e,u.bind({w:t,xhr:n,queryParam:e}),n))}function o(t){var r=t.input;r.classList.remove(I),r.classList.remove(C),e(r,w,null)}function a(t,e,r){return t.utilprops.prepop=r||!1,t.utilprops.val!==e&&(t.utilprops.changed=!0,t.utilprops.val=e,(e.length<t.minChars||0==e.length)&&o(t),e.length<t.minChars||p(t,e)),t}function s(t){var e,r=this;t.target===r.input&&(e=r.utilprops.convertInput(r.input.value),a(r,e))}function c(t){return E.create("li",{innerHTML:t,"aria-selected":"false"})}function v(t){return t.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;")}function d(t){var e,r,n=this,i=n.s,l=n.z,u=n.b;t.target===E(i)&&("function"==typeof u?u(t,l):(e=E(u),e&&e!==document.activeElement&&(r=(void 0!==l&&t.detail?t.detail[l]:t.detail)||"",void 0!==e.value?e.value=r:void 0!==e.src?e.src=r:e.innerHTML=r)))}function f(t){var e,r=this;t.target===E(r.btnId)&&(e=E(r.w),0===e.ul.childNodes.length?(e.minChars=0,e.evaluate()):e.ul.hasAttribute("hidden")?e.open():e.close())}function h(t,e,r){var n=E.regExpEscape(v(e).trim()),i=r?RegExp("^"+n,"i"):RegExp("(?!<[^>]+?>)"+n+"(?![^<]*?>)","gi");return t.replace(i,"<mark>$&</mark>")}function m(t,e,r,n,i){var l,u=i.root,p=i.value,o=i.label||i.value,a=!0,s=[];if(0===n&&u&&r&&0!==(r+".").lastIndexOf(u+".",0)&&0!==(u+".").lastIndexOf(r+".",0))return t;if(Object(e)!==e)r?t[r]=e:t=e;else if(Array.isArray(e)){for(l=0;l<e.length;l++)s.push(m({},e[l],"",n+1,i));r?t[r]=s:t=s}else{for(l in e)a=!1,m(t,e[l],r?r+"."+l:l,n,i);a&&r&&(t[r]={})}return 2>n&&r&&(p&&0===(r+".").lastIndexOf(p+".",0)&&(t.value=t[r]),o&&0===(r+".").lastIndexOf(o+".",0)&&(t.label=t[r])),t}function y(){var t=this,e=t.w.input,r=t.bm,n=t.bi,i=t.bk;e.removeEventListener(g,r),e.removeEventListener(L,r),e.removeEventListener("blur",r),e.removeEventListener("input",n),e.removeEventListener("keydown",i)}var b="awesomplete-",g=b+"loadcomplete",L=b+"close",w=b+"match",A=b+"prepop",I="awe-found",C="awe-not-found",E=Awesomplete.$;return{ajax:function(t,e,r,n,i){return i=i||new XMLHttpRequest,i.open("GET",t+encodeURIComponent(r)+(e||"")),i.onload=n,i.send(),i},convertInput:function(t){return"string"==typeof t?t.trim().toLowerCase():""},mark:h,itemContains:function(t,e){var r;return""!==e.trim()&&(r=(""+t).split(/<p>/),r[0]=h(r[0],e),t=r.join("<p>")),c(t,e)},itemStartsWith:function(t,e){return c(""===e.trim()?""+t:h(""+t,e,!0),e)},createAwesomplete:function(t,e,r){r.item=r.item||this.itemContains;var n=new Awesomplete(t,r);return n.utilprops=e||{},n.utilprops.url||void 0!==n.utilprops.loadall||(n.utilprops.loadall=!0),n.utilprops.ajax=n.utilprops.ajax||this.ajax,n.utilprops.convertInput=n.utilprops.convertInput||this.convertInput,n},attach:function(t){var e=t.input,r=n.bind(t),l=i.bind(t),u=s.bind(t),o=y.bind({w:t,bm:r,bi:u,bk:l}),a={keydown:l,input:u};return a.blur=a[L]=a[g]=r,E.bind(e,a),t.utilprops.detach=o,t.utilprops.prepop&&(t.utilprops.loadall||""!==e.value)&&(t.utilprops.val=t.utilprops.convertInput(e.value),p(t,t.utilprops.val)),t},update:function(t,e,r){return t.input.value=e,a(t,e,r)},startAwesomplete:function(t,e,r){return this.attach(this.createAwesomplete(t,e,r))},detach:function(t){return t.utilprops.detach&&(t.utilprops.detach(),delete t.utilprops.detach),t},createCopyFun:function(t,e,r){return d.bind({s:t,z:e,b:r})},attachCopyFun:function(t,e){return e="boolean"==typeof e?e:!0,addEventListener(w,t),e&&addEventListener(A,t),t},startCopy:function(t,e,r,n){return this.attachCopyFun(this.createCopyFun(t,e,r),n)},detachCopyFun:function(t){return removeEventListener(A,t),removeEventListener(w,t),t},createClickFun:function(t,e){return f.bind({btnId:t,w:e})},attachClickFun:function(t){return addEventListener("click",t),t},startClick:function(t,e){return this.attachClickFun(this.createClickFun(t,e))},detachClickFun:function(t){return removeEventListener("click",t),t},filterContains:function(t,e){return Awesomplete.FILTER_CONTAINS(t.value,e)},filterStartsWith:function(t,e){return Awesomplete.FILTER_STARTSWITH(t.value,e)},jsonFlatten:function(t){return m({},t,"",0,this)}}}();